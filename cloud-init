#cloud-config
package_upgrade: true
packages:
  - nginx
  - php-fpm
  - composer
  - git

write_files:
  - path: /etc/nginx/sites-available/sport-registration.conf
    permissions: '0644'
    content: |
      server {
          listen 80;
          server_name _;
          root /var/www/html/sport-registration;
          index index.php index.html index.htm;
          location / {
              try_files $uri $uri/ =404;
          }
          location ~ \.php$ {
              include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/var/run/php/php-fpm.sock;
          }
          location ~ /\.ht {
              deny all;
          }
      }

runcmd:
  - apt install php-dom php-gd php-simplexml php-xml php-xmlreader php-xmlwriter php-zip -y
  - PHP_VERSION=$(php -r "echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;")
  - sed -i "s|fastcgi_pass unix:/var/run/php/php-fpm.sock;|fastcgi_pass unix:/var/run/php/php${PHP_VERSION}-fpm.sock;|" /etc/nginx/sites-available/sport-registration.conf
  - rm /etc/nginx/sites-enabled/default
  - ln -s /etc/nginx/sites-available/sport-registration.conf /etc/nginx/sites-enabled/
  - systemctl restart nginx
  - systemctl restart php${PHP_VERSION}-fpm
  - cd /var/www/html
  - composer init --no-interaction --name="$USER/html" --description="sport-registration"
  - composer require phpoffice/phpspreadsheet
  - git clone https://github.com/richtertoralf/sport-registration/
  - chown -R www-data:www-data /var/www/html/sport-registration
  - chmod -R 775 /var/www/html
